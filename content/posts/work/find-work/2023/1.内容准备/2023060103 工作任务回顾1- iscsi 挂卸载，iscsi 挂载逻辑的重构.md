---
title: "工作任务回顾1- iscsi 挂卸载，iscsi 挂载逻辑的重构"
subtitle: ""
description: ""
date: 2023-06-01T03:49:00+08:00
draft: true
authors: [索隆不喝酒]
tags: []
series: [card]
categories: [灵感、文献笔记（非永久笔记）]
series_weight: 1
seriesNavigation: true
featuredImage: ""
featuredImagePreview: ""
---
<!--more-->
#

{{< admonition warning "about card" false >}}

这是一个临时性的**卡片文章**，之后可能:
1. `针对该卡片进行扩展，形成文章`
2. `与已有文章关联，组织到其他文章`
3. `删除`

{{< /admonition>}}

## 关于之前的 ECS、EBS 的架构回顾（CECSTACK）

服务有：
- ecs-server
- ecs-node-agent
- ebs
- rbd-driver
- storage-driver

一个虚机创建的大概流程：

![图 1](images/posts/20230601-043327289.png)  

## iscsi 服务端与客户端之间的链路映射是什么样的？

![图 2](images/posts/20230601-151437467.png)  

## 挂载的流程是怎么样的？

我主要做的是数据面的挂载，就是如何把 iscsi 提供的盘挂载到物理机上：

请求 -- ecs-server -- ebs-server -- csi-driver（init connection）

target（lunid，sid） -- node-agent -- sid find hctl （）


## 针对这个特性可能提到的问题

针对 "ecs、ebs的iSCSI挂载逻辑优化重构" 这个特性开发，以下是一些问题，用来评估面试者对于这个特性的理解以及整个架构和流程的掌握程度：

1. 请解释一下ECS和EBS在华为OD公司的架构中的角色和功能。
2. 为什么需要对ECS和EBS的iSCSI挂载逻辑进行优化重构？目前存在哪些问题或痛点？
3. 请描述一下您在这个特性开发中的具体任务和职责。
4. 在优化重构过程中，您会采取哪些措施来提升iSCSI挂载逻辑的性能和可靠性？
5. 您在这个特性开发中是否涉及到与其他团队或服务之间的协作？如果有，具体是哪些团队或服务，以及如何协作的？
6. 在重构过程中，如何保证ECS和EBS的兼容性和平滑过渡？是否会对现有用户产生影响？如何解决这些问题？
7. 您在特性开发过程中遇到的最大挑战是什么？如何解决的？
8. 在您的设计中是否考虑了高可用性和故障恢复方面的因素？如果有，您是如何实现的？
9. 在特性开发完成后，您如何进行测试和验证以确保它的稳定性和正确性？
10. 请描述一下您在特性开发过程中使用的开发工具和流程。

这些问题旨在评估面试者对于这个特性开发的理解，以及他们在架构设计、性能优化、协作和测试方面的能力。希望这能帮助你进行面试评估。如有其他需要，请随时告诉我。

如果您希望在Pod中的虚拟机实例中挂载磁盘，需要使用容器化的虚拟化技术，例如在Kubernetes中使用libvirt。以下是大致的步骤：

1. 配置libvirt：在Kubernetes集群的节点上，您需要安装并配置libvirt，这是一个开源的虚拟化管理工具。确保libvirt已正确配置，可以管理宿主机上的虚拟机。

2. 创建虚拟机定义：使用libvirt提供的工具（如virt-install）或者通过定义虚拟机描述文件（XML格式），创建虚拟机的定义。在虚拟机定义中，您可以指定虚拟机的磁盘设备和挂载方式。

3. 创建Pod：在Kubernetes中创建Pod的配置文件，并在其中定义一个或多个容器。一个容器将运行虚拟机实例，该容器需要与libvirt进行交互。

4. 容器内运行libvirt：在Pod的配置中，定义一个容器来运行libvirt。这个容器将提供对libvirt的访问和管理功能，以便创建、启动和管理虚拟机实例。

5. 磁盘挂载：在虚拟机实例的定义中，指定磁盘设备和挂载点。这可以通过虚拟机描述文件的XML配置或者在容器内使用libvirt的API进行动态配置来实现。挂载磁盘可以将外部存储卷或者宿主机上的存储资源挂载到虚拟机实例中。

6. 启动虚拟机：使用libvirt提供的命令或API，在容器内启动虚拟机实例。libvirt将根据虚拟机定义中的配置，创建虚拟机实例并挂载磁盘。

7. 使用磁盘：一旦虚拟机实例启动并成功挂载磁盘，您可以在虚拟机内部操作系统中使用常规的文件操作命令和API，在磁盘上读取、写入和管理文件。

需要注意的是，具体的配置和步骤可能会因使用的libvirt版本、虚拟机镜像、存储卷类型和Kubernetes配置而有所不同。建议参考相关文档和指南，以了解更详细的步骤和配置选项。


## 任务2. 镜像缓存

这个是创建了一个 job 任务
    job 里面的脚本使用 curl 命令直接请求 csi-driver 初始化连接，然后根据得到的 sid 判断做 rescan 或者 login
    然后做 qemu-convert 导入

为什么叫镜像缓存？缓存体现在哪里啊？
    之后虚机如果只用这个 .qcow2 来创建，就不需要重复导入了


## 自定义镜像

用户可以从一个系统盘导出镜像

![图 3](images/posts/20230601-212026027.png)  

传给 job 的环境变量不包含快照的话则创建一个临时快照，然后使用 rbd export 命令，将对应池里面的那个盘，导出到管道，然后使用 s3 命令传到 minio 后端

## ceake 流水线

这个项目前期我参与的就是跟组内其他成员一起走通一个流程，
编译各种组件的镜像 -- 

##